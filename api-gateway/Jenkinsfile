// Jenkins declarative pipeline for api-gateway service
pipeline {
  agent any
  options { timestamps(); ansiColor('xterm'); }

  parameters {
    string(name: 'IMAGE_TAG', 
           defaultValue: "${env.BRANCH_NAME}-${env.BUILD_NUMBER}", 
           description: 'Docker image tag to use')
  }

  environment {
    SERVICE_NAME = 'api-gateway'
    DOCKER_REPO = 'your-dockerhub-namespace'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    // NEW STAGE: Skip if no changes in this microservice
    stage('Check for Changes') {
      steps {
        script {
          def changed = sh(
            script: """
              git fetch origin ${env.BRANCH_NAME}
              git diff --name-only origin/${env.BRANCH_NAME}...HEAD | grep '^api-gateway/' || true
            """,
            returnStdout: true
          ).trim()

          if (changed == "") {
            echo "No changes detected in api-gateway. Skipping build."
            currentBuild.result = 'NOT_BUILT'
            error("Skipping build for api-gateway")
          } else {
            echo "Detected changes in api-gateway:"
            echo changed
          }
        }
      }
    }

    stage('Build & Test') {
      steps {
        sh 'chmod +x mvnw'
        sh './mvnw -B clean verify'
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
        }
      }
    }

    stage('Docker Build') {
      steps {
        script {
          def imageTag = params.IMAGE_TAG ?: "${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
          env.IMAGE_NAME = "${DOCKER_REPO}/${SERVICE_NAME}:${imageTag}"
        }
        sh 'docker build -t "$IMAGE_NAME" .'
      }
    }

    stage('Docker Push') {
      when { expression { currentBuild.currentResult == 'SUCCESS' } }
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
          sh 'echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin'
          sh 'docker push "$IMAGE_NAME"'
        }
      }
    }
  }

  post {
    success { echo "Built & pushed ${env.IMAGE_NAME}" }
    failure { echo "Build failed or skipped for ${env.SERVICE_NAME}" }
  }
}
