// Jenkins declarative pipeline for movie-service
pipeline {
  agent any
  options { timestamps() }

  parameters {
    string(
      name: 'IMAGE_TAG',
      defaultValue: "main-${env.BUILD_NUMBER}",
      description: 'Docker image tag to use'
    )
  }

  environment {
    SERVICE_NAME = 'api-gateway'
    // DOCKER_REPO = 'transyltoonia'   // previous repo (commented)
    DOCKER_REPO = 'ketan803'           // your DockerHub repo


    // macOS: Ensure Jenkins sees Docker CLI
    PATH = "/usr/local/bin:/opt/homebrew/bin:/Applications/Docker.app/Contents/Resources/bin:${env.PATH}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Check for Changes') {
      steps {
        script {
          sh "git fetch origin main"

          def changed = sh(
            script: """
              git diff --name-only HEAD~1 HEAD | grep "${SERVICE_NAME}/" || true
            """,
            returnStdout: true
          ).trim()

          if (changed == "") {
            echo "No changes detected in ${SERVICE_NAME}. Skipping build."
            currentBuild.result = 'NOT_BUILT'
            error("Skipping build for ${SERVICE_NAME}")
          } else {
            echo "Detected changes in ${SERVICE_NAME}:"
            echo changed
          }
        }
      }
    }

    stage('Build & Test') {
      steps {
        dir("${SERVICE_NAME}") {
          sh 'chmod +x mvnw'
          sh './mvnw -B clean verify'
        }
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: "${SERVICE_NAME}/target/surefire-reports/*.xml"
        }
      }
    }

    stage('Docker Build') {
      steps {
        script {
          def imageTag = params.IMAGE_TAG ?: "main-${env.BUILD_NUMBER}"
          env.IMAGE_NAME = "${DOCKER_REPO}/${SERVICE_NAME}:${imageTag}"
        }
        dir("${SERVICE_NAME}") {
          sh 'docker build -t "$IMAGE_NAME" .'
        }
      }
    }

    stage('Docker Push') {
      when { expression { currentBuild.currentResult == 'SUCCESS' } }
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'docker_creds',
          usernameVariable: 'DOCKER_USERNAME',
          passwordVariable: 'DOCKER_PASSWORD'
        )]) {
          sh 'echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin'
          sh 'docker push "$IMAGE_NAME"'
        }
      }
    }
  }


  post {
    success {
      echo "Build ${env.BUILD_NUMBER} passed"
        script {
            if (fileExists('coverage/lcov-report/index.html')) {
                publishHTML(target: [
                    reportDir: 'coverage/lcov-report',
                    reportFiles: 'index.html',
                    reportName: 'Jest Coverage Report'
                ])
            } else {
                echo "No coverage report found to publish."
            }
        }

        // Send success email
    //     emailext(
    //       subject: "Build SUCCESS | ${SERVICE_NAME} | Build #${env.BUILD_NUMBER}",
    //       body: """
    //           <p>Hello Team,</p>

    //           <p>The CI pipeline for the microservice <b>${SERVICE_NAME}</b> has completed successfully.</p>

    //           <h3>Build Summary</h3>
    //           <table border="1" cellpadding="6" cellspacing="0">
    //               <tr><td><b>Microservice</b></td><td>${SERVICE_NAME}</td></tr>
    //               <tr><td><b>Job Name</b></td><td>${env.JOB_NAME}</td></tr>
    //               <tr><td><b>Build Number</b></td><td>${env.BUILD_NUMBER}</td></tr>
    //               <tr><td><b>Build Status</b></td><td>SUCCESS</td></tr>
    //               <tr><td><b>Triggered By</b></td><td>${env.BUILD_USER ?: 'Webhook / SCM Trigger'}</td></tr>
    //               <tr><td><b>Git Branch</b></td><td>main</td></tr>
    //               <tr><td><b>Docker Image</b></td><td>${IMAGE_NAME}</td></tr>
    //               <tr><td><b>Build URL</b></td>
    //                   <td><a href="${env.BUILD_URL}">${env.BUILD_URL}</a></td>
    //               </tr>
    //           </table>

    //           <p>All stages (Checkout, Test, Build, and Push) executed successfully.</p>

    //           <p>Regards,<br>
    //           Jenkins CI System</p>
    //       """,
    //       mimeType: 'text/html',
    //       to: 'Ajitesh.Kumar@iiitb.ac.in'
    //   )

    // }

    // failure {
    //     echo "Build ${env.BUILD_NUMBER} failed"
    //     emailext(
    //       subject: "Build FAILED | ${SERVICE_NAME} | Build #${env.BUILD_NUMBER}",
    //       body: """
    //           <p>Hello Team,</p>

    //           <p>The CI pipeline for the microservice <b>${SERVICE_NAME}</b> has failed.</p>

    //           <h3>Failure Summary</h3>
    //           <table border="1" cellpadding="6" cellspacing="0">
    //               <tr><td><b>Microservice</b></td><td>${SERVICE_NAME}</td></tr>
    //               <tr><td><b>Job Name</b></td><td>${env.JOB_NAME}</td></tr>
    //               <tr><td><b>Build Number</b></td><td>${env.BUILD_NUMBER}</td></tr>
    //               <tr><td><b>Build Status</b></td><td>FAILED</td></tr>
    //               <tr><td><b>Git Branch</b></td><td>main</td></tr>
    //               <tr><td><b>Docker Image (if built)</b></td><td>${env.IMAGE_NAME ?: 'Not Generated'}</td></tr>
    //               <tr><td><b>Build Logs</b></td>
    //                   <td>
    //                     <a href="${env.BUILD_URL}console">
    //                       View Console Output
    //                     </a>
    //                   </td>
    //               </tr>
    //           </table>

    //           <p>Immediate attention is required to diagnose and resolve the failure.</p>

    //           <p>Regards,<br>
    //           Jenkins CI System</p>
    //       """,
    //       mimeType: 'text/html',
    //       to: 'Ajitesh.Kumar@iiitb.ac.in'
    //   )
    }
  }
}

